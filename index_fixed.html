<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Intranet by Sekizinci</title>
  <meta http-equiv="refresh" content="600">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg1: #071a2b; --bg2: #0c2a4a;
      --card: rgba(255, 255, 255, 0.08);
      --accent: #fce300; --text: #ffffff;
      --muted: rgba(255, 255, 255, 0.6);
      --border: rgba(255, 255, 255, 0.15);
      --success: #3ddc97; --danger: #ff4d4d;
      --info: #3498db;
    }
    body {
      margin: 0; min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
      display: flex; flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
    }
    header { padding: 30px 20px 10px; display: flex; align-items: center; justify-content: space-between; }
    .logo-area { display: flex; align-items: baseline; gap: 8px; }
    .logo-main { font-size: 26px; font-weight: 800; letter-spacing: -1px; color: var(--accent); }
    .logo-sub { font-size: 14px; font-weight: 400; color: var(--muted); text-transform: uppercase; }
    .clock-area { text-align: right; }
    #digital-clock { font-size: 22px; font-weight: 300; color: #fff; }
    #weather-vianen { font-size: 12px; color: var(--accent); margin-top: 2px; }
    #current-date { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-top: 2px; }

    main { padding: 15px; display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { main { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1200px) { main { grid-template-columns: repeat(3, 1fr); } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 15px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

    .big-value { font-size: 36px; font-weight: 800; }
    .big-unit { font-size: 14px; font-weight: 400; color: var(--muted); margin-left: 4px; }
    .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .sensor-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; border: 1px solid var(--border); }
    .sensor-label { font-size: 10px; color: var(--muted); margin-bottom: 5px; text-transform: uppercase; }
    .sensor-val { font-size: 20px; font-weight: 700; }

    .btn { background: var(--accent); color: #000; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.95); opacity: 0.8; }
    .btn-danger { background: var(--danger); color: #fff; }

    .status-list { display: flex; flex-direction: column; gap: 8px; }
    .status-item { background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .up { background: var(--success); box-shadow: 0 0 10px var(--success); }
    .down { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

    .traffic-pill { font-size: 12px; padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.05); }

    .search-box { display: flex; gap: 10px; position: relative; margin-bottom: 10px; }
    .search-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 12px 15px; color: #fff; box-sizing: border-box; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #0c2a4a; border: 1px solid var(--border); border-radius: 12px; margin-top: 5px; z-index: 100; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .book-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; cursor: pointer; }
    .book-item:last-child { border: none; }
    .book-item:hover { background: rgba(255,255,255,0.05); }
    .book-thumb { width: 40px; height: 55px; border-radius: 4px; object-fit: cover; }
    
    /* Kütüphane Izgarası Genişletildi */
    .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
    .book-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 15px; border: 1px solid var(--border); text-align: center; }
    .book-card img { width: 100%; border-radius: 8px; aspect-ratio: 2/3; object-fit: cover; margin-bottom: 8px; }
  </style>
</head>
<body>

  <header>
    <div class="logo-area">
      <div class="logo-main">CCIE LAB</div>
      <div class="logo-sub">Intranet Systems</div>
    </div>
    <div class="clock-area">
      <div id="digital-clock">00:00:00</div>
      <div id="weather-vianen">Vianen: --°C</div>
      <div id="current-date">PAZARTESİ, 1 OCAK</div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-header">
        <div class="card-title">FAN KONTROL</div>
        <div id="fan-status-pill" class="traffic-pill">SİSTEM AKTİF</div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn" onclick="controlFan('AC')">AÇ</button>
        <button class="btn btn-danger" onclick="controlFan('KAPAT')">KAPAT</button>
      </div>
      <div class="card-header" style="margin-top:10px;">
        <div class="card-title">KÜTÜPHANE / ISBN</div>
      </div>
      <div class="search-box">
        <input type="text" id="bookSearch" class="search-input" placeholder="ISBN veya Kitap ara...">
        <button class="btn" style="padding: 0 20px;" onclick="searchBooks()">ARA</button>
        <div id="searchResults" class="search-results"></div>
      </div>
      <div id="myBooksContainer" class="books-grid">
        </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">NETWORK MONITOR</div>
        <div class="traffic-pill" id="update-ts">00:00:00</div>
      </div>
      <div class="status-list" id="ping-list">
        <div class="status-item"><div style="font-size:13px; color:var(--muted);">Ping yükleniyor...</div></div>
      </div>
      <div class="status-list" id="wifi-list" style="margin-top:5px; max-height:150px; overflow-y:auto;">
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">SWITCH TRAFFIC</div>
        <div class="traffic-pill" style="color:var(--success)">G0/5</div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="sensor-label">GELEN</div>
          <div class="big-value" id="in-val">0.0<span class="big-unit">bps</span></div>
        </div>
        <div style="text-align:right;">
          <div class="sensor-label">GİDEN</div>
          <div class="big-value" id="out-val" style="color:var(--info)">0.0<span class="big-unit">bps</span></div>
        </div>
      </div>
      <div style="height:120px;">
        <canvas id="trafficChart"></canvas>
      </div>
      <div class="sensor-grid">
        <div class="sensor-box">
          <div class="sensor-label">SICAKLIK</div>
          <div class="sensor-val" id="temp-val">--°C</div>
        </div>
        <div class="sensor-box">
          <div class="sensor-label">NEM</div>
          <div class="sensor-val" id="hum-val">%--</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "http://api.ccie.lab:5000";

    function formatBW(bps) {
        if (bps >= 1000000) return (bps / 1000000).toFixed(2) + '<span class="big-unit">Mbps</span>';
        if (bps >= 1000) return (bps / 1000).toFixed(1) + '<span class="big-unit">Kbps</span>';
        return bps.toFixed(0) + '<span class="big-unit">bps</span>';
    }

    function updateClock() {
      const now = new Date();
      document.getElementById('digital-clock').textContent = now.toLocaleTimeString('tr-TR');
      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      document.getElementById('current-date').textContent = now.toLocaleDateString('tr-TR', options).toUpperCase();
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function fetchWeather() {
      try {
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=51.99&longitude=5.09&current_weather=true`);
        const d = await r.json();
        document.getElementById('weather-vianen').textContent = `Vianen: ${d.current_weather.temperature}°C`;
      } catch(e) { document.getElementById('weather-vianen').textContent = "Vianen: N/A"; }
    }
    setInterval(fetchWeather, 300000);
    fetchWeather();

    async function fetchPing() {
      try {
        const r = await fetch(`${API_BASE}/ping`);
        const data = await r.json();
        const container = document.getElementById('ping-list');
        container.innerHTML = data.map(i => `
          <div class="status-item">
            <div style="display:flex; align-items:center;">
              <span class="dot ${i.status === 'UP' ? 'up' : 'down'}"></span>
              <span style="font-weight:600; font-size:13px;">${i.host}</span>
            </div>
            <div style="font-size:11px; color:var(--muted);">${i.latency}</div>
          </div>
        `).join('');
      } catch (e) {}
    }

    const trafficCtx = document.getElementById('trafficChart').getContext('2d');
    const trafficChart = new Chart(trafficCtx, {
      type: 'line',
      data: {
        labels: Array(20).fill(''),
        datasets: [{
          label: 'In', data: Array(20).fill(0),
          borderColor: '#3ddc97', borderWidth: 2, fill: true,
          backgroundColor: 'rgba(61, 220, 151, 0.1)', tension: 0.4, pointRadius: 0
        }, {
          label: 'Out', data: Array(20).fill(0),
          borderColor: '#3498db', borderWidth: 2, fill: true,
          backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.4, pointRadius: 0
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { display: false }, x: { display: false } }
      }
    });

    async function fetchTraffic() {
      try {
        const r = await fetch(`${API_BASE}/traffic`);
        const data = await r.json();
        document.getElementById('in-val').innerHTML = formatBW(data.in_raw);
        document.getElementById('out-val').innerHTML = formatBW(data.out_raw);
        document.getElementById('update-ts').textContent = data.ts;

        trafficChart.data.datasets[0].data.shift();
        trafficChart.data.datasets[0].data.push(data.in_raw / 1000000);
        trafficChart.data.datasets[1].data.shift();
        trafficChart.data.datasets[1].data.push(data.out_raw / 1000000);
        trafficChart.update('none');
      } catch (e) {}
    }

    async function fetchSensors() {
      try {
        const r = await fetch(`${API_BASE}/data`);
        const data = await r.json();
        document.getElementById('temp-val').textContent = data.temperature + '°C';
        document.getElementById('hum-val').textContent = '%' + data.humidity;
      } catch (e) {}
    }

    async function fetchMyBooks() {
      try {
        const r = await fetch(`${API_BASE}/books/list`);
        const books = await r.json();
        const container = document.getElementById('myBooksContainer');
        container.innerHTML = books.map(book => `
          <div class="book-card">
            <img src="${book.cover_url || 'https://via.placeholder.com/150'}">
            <div style="font-weight:700; font-size:11px; height:28px; overflow:hidden;">${book.title}</div>
          </div>
        `).join('');
      } catch (e) {}
    }

    async function searchBooks() {
      const q = document.getElementById('bookSearch').value;
      if (q.length < 3) return;
      const results = document.getElementById('searchResults');
      results.style.display = 'block';
      results.innerHTML = '<div style="padding:10px;">Aranıyor...</div>';
      try {
        const r = await fetch(`${API_BASE}/books/search?q=${q}`);
        const data = await r.json();
        results.innerHTML = data.map(b => `
          <div class="book-item" onclick='saveBook(${JSON.stringify(b).replace(/'/g, "&apos;")})'>
            <img src="${b.cover_url}" class="book-thumb">
            <div style="flex:1;">
              <div style="font-size:12px; font-weight:700;">${b.title}</div>
              <div style="font-size:10px; color:var(--muted);">${b.author}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {}
    }

    async function saveBook(book) {
      await fetch(`${API_BASE}/books/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(book)
      });
      document.getElementById('searchResults').style.display = 'none';
      fetchMyBooks();
    }

    async function controlFan(action) {
      const pill = document.getElementById('fan-status-pill');
      pill.textContent = "İŞLENİYOR...";
      await fetch(`${API_BASE}/control/${action}`);
      pill.textContent = action === 'AC' ? 'FAN AÇIK' : 'FAN KAPALI';
      pill.style.color = action === 'AC' ? 'var(--success)' : 'var(--danger)';
    }

    fetchPing(); fetchTraffic(); fetchSensors(); fetchMyBooks();
    setInterval(fetchPing, 10000);
    setInterval(fetchTraffic, 3000);
    setInterval(fetchSensors, 5000);
  </script>
</body>
</html>