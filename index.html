<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Intranet by Sekizinci</title>
  <meta http-equiv="refresh" content="600">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg1: #071a2b; --bg2: #0c2a4a;
      --card: rgba(255, 255, 255, 0.08);
      --accent: #fce300; --text: #ffffff;
      --muted: rgba(255, 255, 255, 0.6);
      --border: rgba(255, 255, 255, 0.15);
      --success: #3ddc97; --danger: #ff4d4d;
      --info: #3498db;
    }
    body {
      margin: 0; min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
      display: flex; justify-content: center;
    }
    .wrap { width: 100%; max-width: 960px; padding-top: 20px; }
    .header { margin-bottom: 24px; padding: 0 4px; }
    .title { font-size: clamp(20px, 6vw, 28px); font-weight: 800; margin: 0; }
    .subtitle { font-size: 13px; color: var(--muted); margin-top: 5px; }

    .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 22px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      padding: 20px; position: relative;
    }
    .card-label {
      text-transform: capitalize; font-size: 11px; letter-spacing: 1.2px;
      color: var(--accent); font-weight: 700; margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }

    .ping-summary-grid { display: flex; gap: 12px; margin-top: 5px; }
    .summary-box {
      flex: 1; padding: 15px; border-radius: 18px; border: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; transition: all 0.3s ease;
    }
    .summary-up { background: rgba(61, 220, 151, 0.1); border-color: rgba(61, 220, 151, 0.3); color: var(--success); }
    .summary-down { background: rgba(255, 77, 77, 0.1); border-color: rgba(255, 77, 77, 0.3); color: var(--danger); }
    .summary-val { font-size: 24px; font-weight: 800; }
    .summary-label { font-size: 10px; text-transform: uppercase; opacity: 0.8; letter-spacing: 1px; margin-top: 4px; }
    .down-list { font-size: 11px; font-weight: 700; margin-top: 5px; word-break: break-all; }

    .wifi-container { margin-top: 15px; max-height: 180px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 14px; border: 1px solid var(--border); }
    .wifi-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .wifi-table th { text-align: left; padding: 8px; color: var(--accent); border-bottom: 1px solid var(--border); position: sticky; top: 0; background: #0c2a4a; z-index: 1; }
    .wifi-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .wifi-container::-webkit-scrollbar { width: 4px; }
    .wifi-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    .sensor-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
    .big-val { font-size: 42px; font-weight: 800; color: var(--text); display: flex; align-items: baseline; }
    .big-val span { font-size: 16px; color: var(--muted); margin-left: 4px; }

    .chart-box { background: rgba(0, 0, 0, 0.2); border-radius: 16px; padding: 10px; border: 1px solid var(--border); margin-top: 10px; height: 220px; }

    .btn {
      flex: 1; border: 1px solid var(--border); background: rgba(255,255,255,0.05);
      color: var(--text); padding: 12px; border-radius: 14px; font-weight: 700;
      font-size: 12px; cursor: pointer; transition: all 0.2s ease;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-on:hover { background: var(--success); color: #000; }
    .btn-off:hover { background: var(--danger); }

    .todo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    .todo-input-row {
      grid-column: 1 / -1; display: flex; gap: 10px;
      background: var(--card); padding: 8px; border-radius: 16px; border: 1px solid var(--border);
    }
    .todo-input-row input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; font-size: 14px; }
    .add-btn { background: var(--accent); color: #000; border: none; padding: 0 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }
    .todo-list { list-style: none; padding: 0; margin: 0; }
    .todo-item {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      padding: 10px 14px; border-radius: 12px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px; border-left: 4px solid var(--accent);
    }
    .todo-item.done { border-left-color: var(--success); opacity: 0.5; text-decoration: line-through; }
    .del-btn { color: var(--danger); background: none; border: none; font-size: 18px; cursor: pointer; padding-left: 10px; }

    .badge-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; padding-bottom: 40px; }
    .badge { background: rgba(255, 255, 255, 0.08); padding: 6px 12px; border-radius: 12px; font-size: 11px; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
    .mono { font-family: ui-monospace, monospace; font-weight: 700; color: var(--accent); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #3ddc97; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">Intranet Portal by Sekizinci</h1>
      <p class="subtitle" id="live-clock">Yükleniyor...</p>
    </div>

    <div class="grid">
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div class="card">
          <div class="card-label">Vianen Saatlik Hava Tahmin Tablosu (Direct API Request to Open Meteo)</div>
          <div class="chart-box"><canvas id="weatherChart"></canvas></div>
        </div>

        <div class="card">
          <div class="card-label"><span class="dot"></span>Ağ Altyapı Özeti (API Request to Zabbix for ICMP Sensors via API GW)</div>
          <div id="ping-summary" class="ping-summary-grid">
            <div style="color:var(--muted); font-size:12px;">Veriler işleniyor...</div>
          </div>
          
          <div class="card-label" style="margin-top: 20px; margin-bottom: 10px;">
            <span class="dot" style="background:var(--info)"></span>Canlı Bant Genişliği Analizi (Zabbix net.if.in/out)
          </div>
          <div class="chart-box" style="height: 160px; margin-top: 0;">
            <canvas id="trafficChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-label">Çevresel Sensör Veri Takibi (SQL Query to PostgreSQL for Temperature and Humidity via API GW)</div>
        <div class="sensor-row">
          <div>
            <div style="font-size:11px; color:var(--muted)">Sıcaklık</div>
            <div class="big-val" id="db-temp">--<span>°C</span></div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted)">Nem</div>
            <div class="big-val" id="db-hum">--<span>%</span></div>
          </div>
        </div>

        <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
          <div class="card-label">Uzaktan IoT Cihaz Yönetimi (Remote Script Execution via SSH/Paramiko for IoT Control via API GW)</div>
          <div style="display:flex; gap:10px;">
            <button class="btn btn-on" onclick="controlFan('AC')">Fan Aç</button>
            <button class="btn btn-off" onclick="controlFan('KAPAT')">Kapat</button>
          </div>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
          <div class="card-label">Pod Kimlik Bilgisi (Runtime Pod Identification via K3s Downward API)</div>
          <div style="font-size: 12px;">
            <span class="mono" id="pod-id" style="display:block; margin-top:4px; font-size:15px; color: #3ddc97; word-break: break-all;">__POD_NAME__</span>
          </div>
          
          <div class="card-label" style="margin-top:15px; font-size:12px;">Kablosuz Ağ İstemci Analizi (API Request to UniFi Controller for Active Wi-Fi Clients via API GW)</div>
          <div class="wifi-container">
            <table class="wifi-table">
              <thead>
                <tr><th>Cihaz</th><th>IP</th><th>MAC</th></tr>
              </thead>
              <tbody id="wifi-list-body">
                <tr><td colspan="3" style="text-align:center; opacity:0.5;">Yükleniyor...</td></tr>
              </tbody>
            </table>
          </div>
          <div style="font-size: 10px; color: var(--muted); margin-top:8px;" id="db-update-time">--</div>
        </div>
      </div>
    </div>

    <div class="todo-grid">
      <div class="todo-input-row">
        <input type="text" id="todoInput" placeholder="Yeni bir iş ekle..." onkeypress="if(event.key==='Enter') addTodo()">
        <button class="add-btn" onclick="addTodo()">EKLE</button>
      </div>
      <div class="card">
        <div class="card-label"><span class="dot" style="background:var(--accent)"></span> Yapılacaklar</div>
        <ul id="pendingList" class="todo-list"></ul>
      </div>
      <div class="card">
        <div class="card-label"><span class="dot" style="background:var(--success)"></span> Yapılanlar</div>
        <ul id="doneList" class="todo-list"></ul>
      </div>
    </div>

    <div class="badge-row">
      <div class="badge"><span class="dot"></span> Online</div>
      <div class="badge">Gateway: <span class="mono">192.168.6.230</span></div>
      <div class="badge">Merkezi Servis Entegrasyonu: <span class="mono">REST API GW</span></div>
      <div class="badge">TZ: <span class="mono" id="geo-tz">--</span></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://192.168.6.230:5000";

    // -------- TO-DO --------
    let todos = JSON.parse(localStorage.getItem('palas_tasks')) || [];
    function renderTodos() {
      const pList = document.getElementById('pendingList');
      const dList = document.getElementById('doneList');
      pList.innerHTML = ''; dList.innerHTML = '';
      todos.forEach((t, i) => {
        const li = document.createElement('li');
        li.className = `todo-item ${t.done ? 'done' : ''}`;
        li.innerHTML = `<span onclick="toggleTodo(${i})">${t.text}</span><button class="del-btn" onclick="delTodo(${i})">×</button>`;
        if (t.done) dList.appendChild(li); else pList.appendChild(li);
      });
      localStorage.setItem('palas_tasks', JSON.stringify(todos));
    }
    function addTodo() { const input = document.getElementById('todoInput'); if (input.value.trim()) { todos.push({ text: input.value, done: false }); input.value = ''; renderTodos(); } }
    function toggleTodo(i) { todos[i].done = !todos[i].done; renderTodos(); }
    function delTodo(i) { todos.splice(i, 1); renderTodos(); }
    renderTodos();

    // -------- CLOCK & FAN --------
    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleString('tr-TR'); }, 1000);
    async function controlFan(a) { try { await fetch(`${API_BASE}/control/${a}`); } catch (e) {} }

    // -------- SENSOR DATA & WIFI --------
    async function fetchLabData() {
      try {
        const res = await fetch(`${API_BASE}/data`);
        const d = await res.json();
        if (d.temperature) {
          document.getElementById('db-temp').firstChild.textContent = d.temperature;
          document.getElementById('db-hum').firstChild.textContent = d.humidity;
          document.getElementById('db-update-time').innerText = "Son Kayıt: " + d.ts;
        }
      } catch (e) {}
    }

    async function fetchWifiClients() {
      try {
        const res = await fetch(`${API_BASE}/wifi`);
        const data = await res.json();
        const tbody = document.getElementById('wifi-list-body');
        if (data.error) return;
        tbody.innerHTML = data.map(c => `<tr><td style="font-weight:700;">${c.name}</td><td class="mono" style="font-size:10px;">${c.ip}</td><td style="opacity:0.5; font-size:9px;">${c.mac}</td></tr>`).join('');
      } catch (e) {}
    }

    // -------- PING SUMMARY --------
    async function fetchPingData() {
      try {
        const res = await fetch(`${API_BASE}/ping`);
        const data = await res.json();
        const total = data.length, up = data.filter(i => i.status === 'UP').length;
        const downDevices = data.filter(i => i.status !== 'UP').map(i => i.host);
        document.getElementById('ping-summary').innerHTML = `
          <div class="summary-box summary-up"><div class="summary-val">${up}/${total}</div><div class="summary-label">ONLINE</div></div>
          <div class="summary-box ${total-up > 0 ? 'summary-down' : 'summary-up'}" style="${total-up === 0 ? 'opacity: 0.4;' : ''}">
            <div class="summary-val">${total-up}</div><div class="summary-label">DOWN</div>
            <div class="down-list">${downDevices.length > 0 ? downDevices.join(', ') : 'Temiz'}</div>
          </div>`;
      } catch (e) {}
    }

    // -------- WEATHER CHART --------
    let weatherChart;
    async function drawWeather() {
      try {
        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.98&longitude=5.10&hourly=temperature_2m&timezone=Europe%2FAmsterdam');
        const d = await res.json();
        document.getElementById('geo-tz').innerText = d.timezone_abbreviation || 'CET';
        const labels = d.hourly.time.slice(0, 12).map(t => t.split('T')[1].slice(0, 5));
        const temps = d.hourly.temperature_2m.slice(0, 12);
        if (weatherChart) weatherChart.destroy();
        weatherChart = new Chart(document.getElementById('weatherChart'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'Temp', data: temps, borderColor: '#fce300', fill: true, backgroundColor: 'rgba(252,227,0,0.1)', tension: 0.4 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(255,255,255,0.4)' } }, y: { ticks: { color: 'rgba(255,255,255,0.2)' } } } }
        });
      } catch(e) {}
    }

    // -------- TRAFFIC CHART (ZABBIX) --------
    let trafficChart;
    const MAX_POINTS = 50; // Geçmiş veri için noktayı artırdık

    function initTrafficChart() {
      const ctx = document.getElementById('trafficChart').getContext('2d');
      trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'Giriş (In)', borderColor: '#3ddc97', backgroundColor: 'rgba(61,220,151,0.1)', data: [], fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'Çıkış (Out)', borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', data: [], fill: true, tension: 0.4, pointRadius: 2 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false }, // Tooltip iyileştirmesi
          plugins: { 
            legend: { labels: { color: 'rgba(255,255,255,0.5)', font: { size: 9 } } },
            tooltip: {
              callbacks: {
                label: function(context) { return context.dataset.label + ': ' + context.parsed.y + ' Mbps'; }
              }
            }
          },
          scales: { 
            x: { display: false }, 
            y: { 
              ticks: { 
                color: 'rgba(255,255,255,0.2)', 
                font: { size: 8 },
                callback: function(value) { return value + ' Mb'; } // Y ekseni birimi
              }, 
              grid: { color: 'rgba(255,255,255,0.05)' } 
            } 
          }
        }
      });
    }

    // Sayfa açılışında geçmiş veriyi çekme fonksiyonu
    async function initTrafficWithHistory() {
      try {
        const res = await fetch(`${API_BASE}/traffic-history`);
        const hist = await res.json();
        if (!hist.error && hist.labels.length > 0) {
          trafficChart.data.labels = hist.labels;
          trafficChart.data.datasets[0].data = hist.in;
          trafficChart.data.datasets[1].data = hist.out;
          trafficChart.update();
        }
      } catch (e) { console.error("History fetch error"); }
      
      // Geçmiş yüklendikten (veya hata aldıktan) sonra canlı döngüyü başlat
      setInterval(updateTraffic, 5000);
    }

    async function updateTraffic() {
      try {
        const res = await fetch(`${API_BASE}/traffic`);
        const data = await res.json();
        const now = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        
        trafficChart.data.labels.push(now);
        trafficChart.data.datasets[0].data.push(data.in);
        trafficChart.data.datasets[1].data.push(data.out);
        
        if (trafficChart.data.labels.length > MAX_POINTS) {
          trafficChart.data.labels.shift();
          trafficChart.data.datasets[0].data.shift();
          trafficChart.data.datasets[1].data.shift();
        }
        trafficChart.update('none');
      } catch (e) {}
    }

    // Başlatıcılar
    initTrafficChart();
    initTrafficWithHistory(); // Önce geçmişi al, sonra canlıyı başlatır
    
    setInterval(fetchLabData, 5000);
    setInterval(fetchPingData, 30000);
    setInterval(fetchWifiClients, 60000);

    fetchLabData(); fetchWifiClients(); fetchPingData(); drawWeather(); updateTraffic();
  </script>
</body>
</html>